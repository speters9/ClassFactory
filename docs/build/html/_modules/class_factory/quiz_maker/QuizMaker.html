

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>class_factory.quiz_maker.QuizMaker &mdash; classfactory 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />


    <link rel="canonical" href="https://speters9.github.io/ClassFactory/_modules/class_factory/quiz_maker/QuizMaker.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../../index.html" class="icon icon-home">
            classfactory
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../class_factory.html">ClassFactory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../class_factory.beamer_bot.html">BeamerBot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../class_factory.concept_web.html">ConceptWeb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../class_factory.quiz_maker.html">QuizMaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../class_factory.utils.html">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">classfactory</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">class_factory.quiz_maker.QuizMaker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for class_factory.quiz_maker.QuizMaker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">**QuizMaker Module**</span>
<span class="sd">-------</span>

<span class="sd">The `QuizMaker` module offers a comprehensive framework for generating, distributing, and analyzing quiz questions based on lesson content and objectives. At its core, the `QuizMaker` class uses a language model (LLM) to create targeted quiz questions, ensuring these questions are relevant to the course material. This class also provides utilities for similarity checking, interactive quiz launches, and detailed results assessment.</span>

<span class="sd">Key Functionalities:</span>
<span class="sd">~~~~~~~</span>

<span class="sd">1. **Quiz Generation**:</span>
<span class="sd">   - Automatically generates quiz questions from lesson objectives and readings.</span>
<span class="sd">   - Customizable difficulty level and quiz content based on user-provided or auto-extracted lesson objectives.</span>

<span class="sd">2. **Similarity Checking**:</span>
<span class="sd">   - Detects overlap with previous quizzes to prevent question duplication.</span>
<span class="sd">   - Uses sentence embeddings to flag and remove questions too similar to prior quizzes.</span>

<span class="sd">3. **Validation and Formatting**:</span>
<span class="sd">   - Validates generated questions to ensure proper format and structure.</span>
<span class="sd">   - Corrects answer formatting to meet quiz standards (e.g., answers in &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>

<span class="sd">4. **Saving Quizzes**:</span>
<span class="sd">   - Exports quizzes as Excel files or PowerPoint presentations.</span>
<span class="sd">   - Customizes PowerPoint presentations using templates for polished quiz slides.</span>

<span class="sd">5. **Interactive Quiz Launch**:</span>
<span class="sd">   - Launches an interactive Gradio-based web quiz for real-time participation.</span>
<span class="sd">   - Supports QR code access and real-time result saving.</span>

<span class="sd">6. **Results Assessment**:</span>
<span class="sd">   - Analyzes and visualizes quiz results stored in CSV files.</span>
<span class="sd">   - Generates summary statistics, HTML reports, and dashboards for insights into quiz performance.</span>

<span class="sd">Dependencies</span>
<span class="sd">~~~~~~~</span>

<span class="sd">This module requires:</span>

<span class="sd">- `langchain_core`: For LLM interaction and prompt handling.</span>
<span class="sd">- `sentence_transformers`: For semantic similarity detection in quiz questions.</span>
<span class="sd">- `pptx`: For PowerPoint presentation generation.</span>
<span class="sd">- `pandas`: For data handling and result assessment.</span>
<span class="sd">- `torch`: For managing device selection and embedding models.</span>
<span class="sd">- `gradio`: For interactive quiz interfaces.</span>
<span class="sd">- Custom utilities for document loading, response parsing, logging, and retry decorators.</span>

<span class="sd">Usage Overview</span>
<span class="sd">~~~~~~~</span>

<span class="sd">1. **Initialize QuizMaker**:</span>
<span class="sd">   - Instantiate `QuizMaker` with required paths, lesson loader, and LLM.</span>

<span class="sd">2. **Generate a Quiz**:</span>
<span class="sd">   - Call `make_a_quiz()` to create quiz questions based on lesson materials, with automatic similarity checking.</span>

<span class="sd">3. **Save the Quiz**:</span>
<span class="sd">   - Use `save_quiz()` to save the quiz as an Excel file or `save_quiz_to_ppt()` to export to PowerPoint.</span>

<span class="sd">4. **Launch an Interactive Quiz**:</span>
<span class="sd">   - Use `launch_interactive_quiz()` to start a web-based quiz, with options for real-time participation and result saving.</span>

<span class="sd">5. **Assess Quiz Results**:</span>
<span class="sd">   - Analyze saved quiz responses with `assess_quiz_results()`, generating summary statistics, reports, and visualizations.</span>

<span class="sd">Example</span>
<span class="sd">~~~~~~~</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from class_factory.quiz_maker.QuizMaker import QuizMaker</span>
<span class="sd">    from class_factory.utils.load_documents import LessonLoader</span>
<span class="sd">    from langchain_openai import ChatOpenAI</span>

<span class="sd">    # Set up paths and initialize components</span>
<span class="sd">    syllabus_path = Path(&quot;/path/to/syllabus.docx&quot;)</span>
<span class="sd">    reading_dir = Path(&quot;/path/to/lesson/readings&quot;)</span>
<span class="sd">    project_dir = Path(&quot;/path/to/project&quot;)</span>
<span class="sd">    llm = ChatOpenAI(api_key=&quot;your_api_key&quot;)</span>

<span class="sd">    # Initialize lesson loader and quiz maker</span>
<span class="sd">    lesson_loader = LessonLoader(syllabus_path=syllabus_path, reading_dir=reading_dir, project_dir=project_dir)</span>
<span class="sd">    quiz_maker = QuizMaker(</span>
<span class="sd">        llm=llm,</span>
<span class="sd">        lesson_no=1,</span>
<span class="sd">        course_name=&quot;Sample Course&quot;,</span>
<span class="sd">        lesson_loader=lesson_loader,</span>
<span class="sd">        output_dir=Path(&quot;/path/to/output/dir&quot;)</span>
<span class="sd">    )</span>

<span class="sd">    # Generate and save a quiz</span>
<span class="sd">    quiz = quiz_maker.make_a_quiz()</span>
<span class="sd">    quiz_maker.save_quiz(quiz)</span>
<span class="sd">    quiz_maker.save_quiz_to_ppt(quiz)</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># base libraries</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># embedding check for similarity against true questions</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="c1"># env setup</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers</span> <span class="kn">import</span> <span class="n">JsonOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain_core.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="c1"># ppt setup</span>
<span class="kn">from</span> <span class="nn">pptx</span> <span class="kn">import</span> <span class="n">Presentation</span>
<span class="kn">from</span> <span class="nn">pptx.dml.color</span> <span class="kn">import</span> <span class="n">RGBColor</span>
<span class="kn">from</span> <span class="nn">pptx.util</span> <span class="kn">import</span> <span class="n">Pt</span>
<span class="kn">from</span> <span class="nn">pyprojroot.here</span> <span class="kn">import</span> <span class="n">here</span>
<span class="c1"># llm chain setup</span>
<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span><span class="p">,</span> <span class="n">util</span>

<span class="kn">from</span> <span class="nn">class_factory.quiz_maker.quiz_prompts</span> <span class="kn">import</span> <span class="n">quiz_prompt</span>
<span class="kn">from</span> <span class="nn">class_factory.quiz_maker.quiz_to_app</span> <span class="kn">import</span> <span class="n">quiz_app</span>
<span class="kn">from</span> <span class="nn">class_factory.quiz_maker.quiz_viz</span> <span class="kn">import</span> <span class="p">(</span><span class="n">generate_dashboard</span><span class="p">,</span>
                                               <span class="n">generate_html_report</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">class_factory.utils.base_model</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">class_factory.utils.llm_validator</span> <span class="kn">import</span> <span class="n">Validator</span>
<span class="kn">from</span> <span class="nn">class_factory.utils.load_documents</span> <span class="kn">import</span> <span class="n">LessonLoader</span>
<span class="kn">from</span> <span class="nn">class_factory.utils.response_parsers</span> <span class="kn">import</span> <span class="n">Quiz</span><span class="p">,</span> <span class="n">ValidatorResponse</span>
<span class="kn">from</span> <span class="nn">class_factory.utils.tools</span> <span class="kn">import</span> <span class="n">retry_on_json_decode_error</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">OPENAI_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;openai_key&#39;</span><span class="p">)</span>
<span class="n">OPENAI_ORG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;openai_org&#39;</span><span class="p">)</span>

<span class="c1"># Path definitions</span>
<span class="n">user_home</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
<span class="n">wd</span> <span class="o">=</span> <span class="n">here</span><span class="p">()</span>

<span class="n">syllabus_path</span> <span class="o">=</span> <span class="n">user_home</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;syllabus_path&#39;</span><span class="p">)</span>
<span class="n">readingDir</span> <span class="o">=</span> <span class="n">user_home</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;readingsDir&quot;</span><span class="p">)</span>

<span class="n">outputDir</span> <span class="o">=</span> <span class="n">wd</span> <span class="o">/</span> <span class="s2">&quot;data/quizzes/&quot;</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="c1"># %%</span>


<span class="c1"># QuizMaker class definition</span>
<div class="viewcode-block" id="QuizMaker">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker">[docs]</a>
<span class="k">class</span> <span class="nc">QuizMaker</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to generate and manage quizzes based on lesson readings and objectives using a language model (LLM).</span>

<span class="sd">    QuizMaker generates quiz questions from lesson content, checks for similarity with prior quizzes to avoid redundancy,</span>
<span class="sd">    and validates question format. Quizzes can be saved as Excel or PowerPoint files, launched interactively, and analyzed for performance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        llm: The language model instance for quiz generation.</span>
<span class="sd">        syllabus_path (Path): Path to the syllabus file.</span>
<span class="sd">        reading_dir (Path): Directory containing lesson readings.</span>
<span class="sd">        output_dir (Path): Directory for saving quiz files.</span>
<span class="sd">        prior_quiz_path (Path): Directory with prior quizzes for similarity checks.</span>
<span class="sd">        lesson_range (range): Range of lessons for quiz generation.</span>
<span class="sd">        course_name (str): Name of the course for context in question generation.</span>
<span class="sd">        device: Device for embeddings (CPU or GPU).</span>
<span class="sd">        rejected_questions (List[Dict]): List of questions flagged as similar to prior quizzes.</span>

<span class="sd">    Methods:</span>
<span class="sd">        make_a_quiz(difficulty_level: int = 5, flag_threshold: float = 0.7) -&gt; List[Dict]:</span>
<span class="sd">            Generates quiz questions with similarity checks to avoid redundancy.</span>

<span class="sd">        save_quiz(quiz: List[Dict]) -&gt; None:</span>
<span class="sd">            Saves quiz questions to an Excel file.</span>

<span class="sd">        save_quiz_to_ppt(quiz: List[Dict] = None, excel_file: Path = None, template_path: Path = None) -&gt; None:</span>
<span class="sd">            Saves quiz questions to a PowerPoint file, optionally with a template.</span>

<span class="sd">        launch_interactive_quiz(quiz_data, sample_size: int = 5, seed: int = 42, save_results: bool = False, output_dir: Path = None, qr_name: str = None) -&gt; None:</span>
<span class="sd">            Launches an interactive quiz using Gradio.</span>

<span class="sd">        assess_quiz_results(quiz_data: pd.DataFrame = None, results_dir: Path = None, output_dir: Path = None) -&gt; pd.DataFrame:</span>
<span class="sd">            Analyzes quiz results and generates summary statistics and visualizations.</span>

<span class="sd">    Internal Methods:</span>
<span class="sd">        _validate_llm_response(quiz_questions: Dict[str, Any], objectives: str, readings: str, prior_quiz_questions: List[str], difficulty_level: int, additional_guidance: str) -&gt; Dict[str, Any]:</span>
<span class="sd">            Validates generated quiz questions for relevance and format.</span>

<span class="sd">        _validate_questions(questions: List[Dict]) -&gt; List[Dict]:</span>
<span class="sd">            Checks for formatting errors and corrects them.</span>

<span class="sd">        _build_quiz_chain() -&gt; Any:</span>
<span class="sd">            Builds the LLM chain for quiz generation.</span>

<span class="sd">        _load_and_merge_prior_quizzes() -&gt; Tuple[List[str], pd.DataFrame]:</span>
<span class="sd">            Loads and merges questions from prior quizzes for similarity checking.</span>

<span class="sd">        _check_question_similarity(generated_questions: List[str], threshold: float = 0.6) -&gt; List[Dict]:</span>
<span class="sd">            Checks for question similarity against prior quizzes.</span>

<span class="sd">        _separate_flagged_questions(questions: List[Dict], flagged_questions: List[Dict]) -&gt; Tuple[List[Dict], List[Dict]]:</span>
<span class="sd">            Separates flagged questions based on similarity results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">lesson_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">course_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lesson_loader</span><span class="p">:</span> <span class="n">LessonLoader</span><span class="p">,</span>
                 <span class="n">output_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prior_quiz_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">lesson_range</span><span class="p">:</span> <span class="nb">range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">quiz_prompt_for_llm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize QuizMaker with lesson paths and configuration options.</span>

<span class="sd">        Args:</span>
<span class="sd">            llm: The language model for quiz generation.</span>
<span class="sd">            lesson_no (int): Current lesson number.</span>
<span class="sd">            course_name (str): Course name for context.</span>
<span class="sd">            lesson_loader (LessonLoader): Utility for loading lesson objectives and readings.</span>
<span class="sd">            output_dir (Union[Path, str], optional): Directory to save quizzes. Defaults to None.</span>
<span class="sd">            prior_quiz_path (Union[Path, str], optional): Directory for prior quizzes to check for question similarity. Defaults to None.</span>
<span class="sd">            lesson_range (range): Range of lessons for quiz generation. Defaults to range(1, 5).</span>
<span class="sd">            quiz_prompt_for_llm (str): LLM prompt template for generating questions. If not provided, reverts to module default prompt.</span>
<span class="sd">            device (optional): Device for embeddings (CPU or GPU). Defaults to CPU if not specified.</span>
<span class="sd">            verbose (bool): Enables verbose logging. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize BaseModel to set up lesson_loader, paths, and logging</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lesson_no</span><span class="o">=</span><span class="n">lesson_no</span><span class="p">,</span> <span class="n">course_name</span><span class="o">=</span><span class="n">course_name</span><span class="p">,</span>
                         <span class="n">lesson_loader</span><span class="o">=</span><span class="n">lesson_loader</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lesson_loader</span><span class="o">.</span><span class="n">_validate_dir_path</span><span class="p">(</span><span class="n">prior_quiz_path</span><span class="p">,</span> <span class="s2">&quot;prior quiz path&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span> <span class="o">=</span> <span class="n">lesson_range</span>

        <span class="c1"># Initialize validator, parser, and similarity model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiz_parser</span> <span class="o">=</span> <span class="n">JsonOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">Quiz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_parser</span> <span class="o">=</span> <span class="n">JsonOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">ValidatorResponse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiz_prompt</span> <span class="o">=</span> <span class="n">quiz_prompt_for_llm</span> <span class="k">if</span> <span class="n">quiz_prompt_for_llm</span> <span class="k">else</span> <span class="n">quiz_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_parser</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>

        <span class="c1"># Set device for similarity checking (default to GPU if available)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">device</span>

        <span class="c1"># Load prior quiz questions for similarity checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_questions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_quizzes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_and_merge_prior_quizzes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_readings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">)</span>

        <span class="c1"># Similarity measures for generated questions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejected_questions</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="QuizMaker.make_a_quiz">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker.make_a_quiz">[docs]</a>
    <span class="nd">@retry_on_json_decode_error</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">make_a_quiz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">difficulty_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">flag_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate quiz questions based on lesson readings and objectives, checking for similarity with prior quizzes.</span>

<span class="sd">        Args:</span>
<span class="sd">            difficulty_level (int): Difficulty of generated questions, scale 1-10. Defaults to 5.</span>
<span class="sd">            flag_threshold (float): Similarity threshold for rejecting duplicate questions. Defaults to 0.7.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: Generated quiz questions, with duplicates removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Leverage `_load_readings` and `extract_lesson_objectives`</span>
        <span class="n">objectives_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">lesson</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">lesson_loader</span><span class="o">.</span><span class="n">extract_lesson_objectives</span><span class="p">(</span><span class="n">lesson</span><span class="p">)</span> <span class="k">for</span> <span class="n">lesson</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">}</span>

        <span class="n">responselist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lesson_no</span><span class="p">,</span> <span class="n">readings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">objectives_text</span> <span class="o">=</span> <span class="n">objectives_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lesson_no</span><span class="p">),</span> <span class="s2">&quot;No objectives available&quot;</span><span class="p">)</span>
            <span class="n">questions_not_to_use</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_questions</span> <span class="o">+</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rejected_questions</span><span class="p">]))</span>

            <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_quiz_chain</span><span class="p">()</span>

            <span class="c1"># Generate questions using the LLM, building in automatic validation</span>
            <span class="n">additional_guidance</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">retries</span><span class="p">,</span> <span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
                    <span class="s2">&quot;course_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_name</span><span class="p">,</span>
                    <span class="s2">&quot;objectives&quot;</span><span class="p">:</span> <span class="n">objectives_text</span><span class="p">,</span>
                    <span class="s2">&quot;information&quot;</span><span class="p">:</span> <span class="n">readings</span><span class="p">,</span>
                    <span class="s1">&#39;prior_quiz_questions&#39;</span><span class="p">:</span> <span class="n">questions_not_to_use</span><span class="p">,</span>
                    <span class="s1">&#39;difficulty_level&#39;</span><span class="p">:</span> <span class="n">difficulty_level</span><span class="p">,</span>
                    <span class="s2">&quot;additional_guidance&quot;</span><span class="p">:</span> <span class="n">additional_guidance</span>
                <span class="p">})</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response from LLM: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># if string, remove the code block indicators (```json and ``` at the end)</span>
                <span class="n">quiz_questions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;```json</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">```&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">response</span>

                <span class="n">val_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_llm_response</span><span class="p">(</span><span class="n">quiz_questions</span><span class="o">=</span><span class="n">quiz_questions</span><span class="p">,</span>
                                                           <span class="n">objectives</span><span class="o">=</span><span class="n">objectives_text</span><span class="p">,</span>
                                                           <span class="n">readings</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">readings</span><span class="p">),</span>
                                                           <span class="n">prior_quiz_questions</span><span class="o">=</span><span class="n">questions_not_to_use</span><span class="p">,</span>
                                                           <span class="n">difficulty_level</span><span class="o">=</span><span class="n">difficulty_level</span><span class="p">,</span>
                                                           <span class="n">additional_guidance</span><span class="o">=</span><span class="n">additional_guidance</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation output: </span><span class="si">{</span><span class="n">val_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">additional_guidance</span> <span class="o">=</span> <span class="n">val_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_guidance&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response validation failed on attempt </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">. &quot;</span>
                                                  <span class="sa">f</span><span class="s2">&quot;Guidance for improvement: </span><span class="si">{</span><span class="n">additional_guidance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Handle validation failure after max retries</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Validation failed after max retries. Ensure correct prompt and input data. Consider trying a different LLM.&quot;</span><span class="p">)</span>

            <span class="n">responselist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_llm_questions</span><span class="p">(</span><span class="n">quiz_questions</span><span class="p">))</span>

        <span class="n">responselist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_questions</span><span class="p">(</span><span class="n">responselist</span><span class="p">)</span>

        <span class="c1"># Check for similarities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_questions</span><span class="p">:</span>
            <span class="c1"># Extract just the question text for similarity checking</span>
            <span class="n">generated_question_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">responselist</span><span class="p">]</span>
            <span class="n">flagged_questions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_question_similarity</span><span class="p">(</span><span class="n">generated_question_texts</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">flag_threshold</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagged questions: </span><span class="si">{</span><span class="n">flagged_questions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Separate flagged and scrubbed questions</span>
            <span class="n">scrubbed_questions</span><span class="p">,</span> <span class="n">flagged_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_separate_flagged_questions</span><span class="p">(</span><span class="n">responselist</span><span class="p">,</span> <span class="n">flagged_questions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rejected_questions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flagged_list</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">scrubbed_questions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">responselist</span></div>


    <span class="k">def</span> <span class="nf">_parse_llm_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz_questions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process LLM-generated questions for consistent structure and formatting.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiz_questions (Union[Dict, List]): Questions generated by the LLM, structured as a dictionary by type or a list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: Processed list of quiz questions, with each question labeled by type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_questions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">question_type</span><span class="p">,</span> <span class="n">questions</span> <span class="ow">in</span> <span class="n">quiz_questions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
                    <span class="n">question</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">question_type</span>
                    <span class="n">processed_questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_questions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">processed_questions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">quiz_questions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_questions</span>

    <span class="k">def</span> <span class="nf">_validate_llm_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz_questions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">objectives</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">readings</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">prior_quiz_questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">difficulty_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">additional_guidance</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate generated quiz questions by checking relevance and formatting.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiz_questions (Dict[str, Any]): LLM-generated quiz questions.</span>
<span class="sd">            objectives (str): Current lesson objectives.</span>
<span class="sd">            readings (str): Lesson readings text for context.</span>
<span class="sd">            prior_quiz_questions (List[str]): Previous quiz questions for similarity checks.</span>
<span class="sd">            difficulty_level (int): Desired difficulty level (1-10).</span>
<span class="sd">            additional_guidance (str): Additional validation instructions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Validation response including evaluation score, status, and suggested improvements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate quiz quality and accuracy</span>
        <span class="n">val_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quiz_prompt</span><span class="p">)</span>
        <span class="n">response_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">quiz_questions</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;}}&quot;</span><span class="p">)</span>
        <span class="n">validation_prompt</span> <span class="o">=</span> <span class="n">val_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">course_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_name</span><span class="p">,</span>
                                                <span class="n">objectives</span><span class="o">=</span><span class="n">objectives</span><span class="p">,</span>
                                                <span class="n">information</span><span class="o">=</span><span class="n">readings</span><span class="p">,</span>
                                                <span class="n">prior_quiz_questions</span><span class="o">=</span><span class="n">prior_quiz_questions</span><span class="p">,</span>
                                                <span class="n">difficulty_level</span><span class="o">=</span><span class="n">difficulty_level</span><span class="p">,</span>
                                                <span class="n">additional_guidance</span><span class="o">=</span><span class="n">additional_guidance</span>
                                                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;}}&quot;</span><span class="p">)</span>

        <span class="n">val_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">task_description</span><span class="o">=</span><span class="n">validation_prompt</span><span class="p">,</span>
                                               <span class="n">generated_response</span><span class="o">=</span><span class="n">response_str</span><span class="p">,</span>
                                               <span class="n">min_eval_score</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                               <span class="n">specific_guidance</span><span class="o">=</span><span class="s2">&quot;Evaluate the quality of both the question and the answer choices for each question.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val_response</span>

    <span class="k">def</span> <span class="nf">_validate_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for and correct formatting issues in quiz questions.</span>

<span class="sd">        Args:</span>
<span class="sd">            questions (List[Dict]): List of generated quiz questions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: Corrected list of questions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">question_num</span><span class="p">,</span> <span class="n">question</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">questions</span><span class="p">):</span>
            <span class="n">correct_answer</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correct_answer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">correct_answer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect formatting with </span><span class="si">{</span><span class="n">question_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">correct_answer</span><span class="si">}</span><span class="s2">. Attempting to correct.&quot;</span><span class="p">)</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">option_letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]:</span>
                    <span class="n">option_text</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">option_letter</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">option_text</span> <span class="ow">and</span> <span class="n">correct_answer</span> <span class="ow">and</span> <span class="n">correct_answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">option_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">question</span><span class="p">[</span><span class="s1">&#39;correct_answer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option_letter</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Corrected formatting error.&quot;</span><span class="p">)</span>
                        <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not match correct_answer &#39;</span><span class="si">{</span><span class="n">correct_answer</span><span class="si">}</span><span class="s2">&#39; to any option in question &#39;</span><span class="si">{</span><span class="n">question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;question&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. Recommend manual fix.&quot;</span><span class="p">)</span>
                    <span class="n">question</span><span class="p">[</span><span class="s1">&#39;correct_answer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">questions</span>

    <span class="k">def</span> <span class="nf">_build_quiz_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the LLM quiz generation chain using prompt, LLM, and output parser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Chain: Quiz generation chain combining prompt template, LLM, and parser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct the prompt template</span>
        <span class="n">combined_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quiz_prompt</span><span class="p">)</span>
        <span class="c1"># Create the chain with the prompt, LLM, and parser</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">combined_template</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiz_parser</span>

        <span class="k">return</span> <span class="n">chain</span>

    <span class="k">def</span> <span class="nf">_load_and_merge_prior_quizzes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and merge previous quiz questions from Excel files for similarity checking.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[str], pd.DataFrame]: List of prior quiz questions and a DataFrame of prior quizzes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_quiz_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">quiz_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Get all Excel files in the prior_quiz_dir</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.xlsx&#39;</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">quiz_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">quiz_df</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;question&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">all_quiz_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Flatten the list of lists into a single list</span>
        <span class="n">merged_questions</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_quiz_data</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">quiz_df</span> <span class="o">=</span> <span class="n">quiz_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">merged_questions</span><span class="p">,</span> <span class="n">quiz_df</span>

    <span class="c1"># Function to check similarity between generated questions and main quiz questions</span>
    <span class="k">def</span> <span class="nf">_check_question_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generated_questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare generated questions to prior quiz questions to flag similar questions.</span>

<span class="sd">        Args:</span>
<span class="sd">            generated_questions (List[str]): List of new quiz questions.</span>
<span class="sd">            threshold (float): Similarity threshold for flagging. Defaults to 0.6.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: List of flagged questions with similarity scores and indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flagged_questions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get embeddings for the newly generated questions and prior quiz questions</span>
        <span class="n">generated_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">generated_questions</span><span class="p">,</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">prior_quiz_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_quiz_questions</span><span class="p">,</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Compare each generated question to prior quiz questions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gen_question</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generated_questions</span><span class="p">):</span>
            <span class="n">cosine_scores</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">pytorch_cos_sim</span><span class="p">(</span><span class="n">generated_embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prior_quiz_embeddings</span><span class="p">)</span>
            <span class="n">max_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cosine_scores</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">max_score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">flagged_questions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">gen_question</span><span class="p">,</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span> <span class="n">max_score</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">flagged_questions</span>

    <span class="k">def</span> <span class="nf">_separate_flagged_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">flagged_questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Separates flagged questions from those that pass similarity checks.</span>

<span class="sd">        Args:</span>
<span class="sd">            questions (List[Dict]): List of generated quiz questions.</span>
<span class="sd">            flagged_questions (List[Dict]): List of questions flagged as similar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[Dict], List[Dict]]: List of valid questions and list of flagged questions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scrubbed_questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flagged_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">flagged_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flagged_questions</span><span class="p">}</span>  <span class="c1"># Get set of flagged indices</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">question</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">questions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flagged_indices</span><span class="p">:</span>
                <span class="n">flagged_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scrubbed_questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scrubbed_questions</span><span class="p">,</span> <span class="n">flagged_list</span>

<div class="viewcode-block" id="QuizMaker.save_quiz">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker.save_quiz">[docs]</a>
    <span class="k">def</span> <span class="nf">save_quiz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save to excel&quot;&quot;&quot;</span>
        <span class="n">final_quiz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">quiz</span><span class="p">)</span>

        <span class="n">col_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;question&#39;</span><span class="p">,</span> <span class="s1">&#39;A)&#39;</span><span class="p">,</span> <span class="s1">&#39;B)&#39;</span><span class="p">,</span> <span class="s1">&#39;C)&#39;</span><span class="p">,</span> <span class="s1">&#39;D)&#39;</span><span class="p">,</span> <span class="s1">&#39;correct_answer&#39;</span><span class="p">]</span>
        <span class="n">final_quiz</span> <span class="o">=</span> <span class="n">final_quiz</span><span class="p">[</span><span class="n">col_order</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">final_quiz</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;l</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">)</span><span class="si">}</span><span class="s2">_quiz.xlsx&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="QuizMaker.save_quiz_to_ppt">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker.save_quiz_to_ppt">[docs]</a>
    <span class="k">def</span> <span class="nf">save_quiz_to_ppt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">excel_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save quiz questions to a PowerPoint presentation, with options to use a template.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiz (List[Dict], optional): List of quiz questions in dictionary format.</span>
<span class="sd">            excel_file (Path, optional): Path to an Excel file containing quiz questions. If provided, it overrides the quiz argument.</span>
<span class="sd">            template_path (Path, optional): Path to a PowerPoint template to apply to the generated slides.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither quiz nor excel_file is provided.</span>

<span class="sd">        Creates a PowerPoint presentation with each question on a slide, followed by the answer slide.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load from Excel if an Excel file path is provided</span>
        <span class="k">if</span> <span class="n">excel_file</span><span class="p">:</span>
            <span class="n">excel_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">excel_file</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">excel_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">quiz</span><span class="p">:</span>
            <span class="c1"># Convert the list of dicts into a DataFrame</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">quiz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;quiz&#39; or &#39;excel_file&#39; must be provided.&quot;</span><span class="p">)</span>

        <span class="n">use_template</span> <span class="o">=</span> <span class="n">template_path</span> <span class="ow">and</span> <span class="n">template_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">use_template</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span>
            <span class="n">prs</span> <span class="o">=</span> <span class="n">Presentation</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">template_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prs</span> <span class="o">=</span> <span class="n">Presentation</span><span class="p">()</span>  <span class="c1"># Use default template if none is provided</span>

        <span class="c1"># Function to add a slide with a title and content</span>
        <span class="k">def</span> <span class="nf">_add_slide</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_answer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)):</span>
            <span class="n">slide_layout</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">slide_layouts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Layout with title and content</span>
            <span class="n">slide</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">add_slide</span><span class="p">(</span><span class="n">slide_layout</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_template</span><span class="p">:</span>
                <span class="c1"># Set slide background color</span>
                <span class="n">background</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">background</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="n">background</span><span class="o">.</span><span class="n">fill</span>
                <span class="n">fill</span><span class="o">.</span><span class="n">solid</span><span class="p">()</span>
                <span class="n">fill</span><span class="o">.</span><span class="n">fore_color</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">RGBColor</span><span class="p">(</span><span class="n">bg_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bg_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bg_color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># Set title text and font size</span>
            <span class="n">title_placeholder</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span>
            <span class="n">title_placeholder</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_template</span><span class="p">:</span>
                <span class="n">title_text_frame</span> <span class="o">=</span> <span class="n">title_placeholder</span><span class="o">.</span><span class="n">text_frame</span>
                <span class="n">title_text_frame</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">Pt</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>  <span class="c1"># Set title font size</span>

            <span class="c1"># Set content text and font size</span>
            <span class="n">text_placeholder</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">placeholders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">text_placeholder</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_template</span><span class="p">:</span>
                <span class="n">content_text_frame</span> <span class="o">=</span> <span class="n">text_placeholder</span><span class="o">.</span><span class="n">text_frame</span>
                <span class="n">content_text_frame</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">Pt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># Set content font size</span>

            <span class="k">if</span> <span class="n">is_answer</span> <span class="ow">and</span> <span class="n">answer</span><span class="p">:</span>
                <span class="c1"># For answers, add the answer text at the end and adjust the font size</span>
                <span class="n">text_placeholder</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Answer: </span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_template</span><span class="p">:</span>
                    <span class="n">content_text_frame</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">Pt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>  <span class="c1"># Adjust answer font size</span>

        <span class="c1"># Loop through each question and add to the presentation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Get question text</span>
            <span class="n">question_text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>

            <span class="c1"># Prepare choices, using .get() to avoid KeyError</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A) </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;A)&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">B) </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;B)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;C)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">choices</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">C) </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;C)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;D)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">choices</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">D) </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;D)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Add a slide for the question</span>
            <span class="n">_add_slide</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Question </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question_text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">choices</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

            <span class="c1"># Add a slide for the answer</span>
            <span class="n">correct_answer</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;correct_answer&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">correct_answer</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]:</span>
                <span class="n">answer_text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">correct_answer</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">]</span>
                <span class="n">_add_slide</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Answer to Question </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question_text</span><span class="p">,</span>
                           <span class="n">answer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">correct_answer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">answer_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">is_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_add_slide</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Answer to Question </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question_text</span><span class="p">,</span>
                           <span class="n">answer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">correct_answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">is_answer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

        <span class="c1"># Function to remove the slide at index 0 (first slide). Only applicable if using a template</span>
        <span class="k">def</span> <span class="nf">_remove_slide_by_index</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Remove the slide at the specified index. Using a template leaves the first slide blank.&quot;&quot;&quot;</span>
            <span class="n">slide_id</span> <span class="o">=</span> <span class="n">pres</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">_sldIdLst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">pres</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">drop_rel</span><span class="p">(</span><span class="n">slide_id</span><span class="o">.</span><span class="n">rId</span><span class="p">)</span>
            <span class="n">pres</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">_sldIdLst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span>

        <span class="c1"># Remove the first slide if using a template</span>
        <span class="k">if</span> <span class="n">use_template</span><span class="p">:</span>
            <span class="n">_remove_slide_by_index</span><span class="p">(</span><span class="n">prs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Save the PowerPoint presentation</span>
        <span class="n">ppt_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;quiz_presentation_</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lesson_range</span><span class="p">)</span><span class="si">}</span><span class="s2">.pptx&quot;</span>
        <span class="k">if</span> <span class="n">excel_file</span><span class="p">:</span>
            <span class="n">ppt_path</span> <span class="o">=</span> <span class="n">excel_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pptx&quot;</span><span class="p">)</span>
        <span class="n">prs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ppt_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Presentation saved at </span><span class="si">{</span><span class="n">ppt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="QuizMaker.launch_interactive_quiz">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker.launch_interactive_quiz">[docs]</a>
    <span class="k">def</span> <span class="nf">launch_interactive_quiz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
                                <span class="n">save_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">qr_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch an interactive quiz using Gradio, sampling questions from provided data or generating new data if none is provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiz_data (Union[pd.DataFrame, Path, str, List[Dict]], optional): Quiz questions as a DataFrame, Excel path, or list of dictionaries. If None, generates new questions.</span>
<span class="sd">            sample_size (int, optional): Number of questions to sample. Defaults to 5.</span>
<span class="sd">            seed (int, optional): Random seed for consistent sampling. Defaults to 42.</span>
<span class="sd">            save_results (bool, optional): Whether to save quiz results. Defaults to False.</span>
<span class="sd">            output_dir (Path, optional): Directory to save quiz results. Defaults to the classs output directory.</span>
<span class="sd">            qr_name (str, optional): Name of the QR code image file for accessing the quiz.</span>

<span class="sd">        Uses the Gradio interface to render the quiz and display results, saving results if specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If quiz_data is a List of Dicts, convert it to a DataFrame</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s a List[Dict]</span>
            <span class="n">quiz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">)</span>

        <span class="c1"># If quiz_data is a path or string, read the file</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">,</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">quiz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">)</span>

        <span class="c1"># If quiz_data is None, generate the quiz dynamically</span>
        <span class="k">elif</span> <span class="n">quiz_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No quiz identified. Generating new quiz from lesson documents&quot;</span><span class="p">)</span>
            <span class="n">quiz_generated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_a_quiz</span><span class="p">()</span>
            <span class="n">quiz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">quiz_generated</span><span class="p">)</span>

        <span class="c1"># If quiz_data is already a DataFrame, use it directly</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">quiz</span> <span class="o">=</span> <span class="n">quiz_data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid type for quiz_data. It must be either a DataFrame, path to an Excel file, or a list of dictionaries.&quot;</span><span class="p">)</span>

        <span class="n">quiz_sampled</span> <span class="o">=</span> <span class="n">quiz</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>

        <span class="n">quiz_app</span><span class="p">(</span><span class="n">quiz_sampled</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="n">save_results</span><span class="p">,</span>
                 <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">qr_name</span><span class="o">=</span><span class="n">qr_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="QuizMaker.assess_quiz_results">
<a class="viewcode-back" href="../../../class_factory.quiz_maker.html#class_factory.quiz_maker.QuizMaker.QuizMaker.assess_quiz_results">[docs]</a>
    <span class="k">def</span> <span class="nf">assess_quiz_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiz_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">results_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze quiz results, generate summary statistics, and visualize responses.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiz_data (pd.DataFrame, optional): DataFrame of quiz results. If None, loads results from CSV files in results_dir.</span>
<span class="sd">            results_dir (Path, optional): Directory containing CSV files of quiz results.</span>
<span class="sd">            output_dir (Path, optional): Directory for saving summary statistics and plots. Defaults to output_dir/&#39;quiz_analysis&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame with summary statistics, including total responses, correct and incorrect counts, and percentage correct.</span>

<span class="sd">        Create a summary report in CSV and HTML format with visualizations and metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s1">&#39;quiz_analysis&#39;</span>

        <span class="c1"># If quiz_data is provided as a DataFrame, use it directly</span>
        <span class="k">if</span> <span class="n">quiz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quiz_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;if passing an object for assessment, it needs to be a pd.DataFrame&quot;</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">quiz_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load from CSV if no DataFrame is provided</span>
            <span class="n">results_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">results_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">results_dir</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s1">&#39;quiz_results&#39;</span>

            <span class="n">csv_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.csv&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">csv_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No CSV files found in directory: </span><span class="si">{</span><span class="n">results_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

            <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">csv_files</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Sort by timestamp to ensure records are in chronological order</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

        <span class="c1"># Remove duplicates keeping last attempt for each user per question</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;question&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Ensure &#39;is_correct&#39; is boolean</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_correct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Calculate summary statistics</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;question&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
            <span class="s1">&#39;Total Responses&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="s1">&#39;Correct Responses&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;is_correct&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="s1">&#39;Incorrect Responses&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;is_correct&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="s1">&#39;Percent Correct&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;is_correct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;Modal Answer&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;user_answer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;user_answer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}),</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Save summary statistics to a CSV file</span>
        <span class="n">summary_output_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s1">&#39;summary_statistics.csv&#39;</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">summary_output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Generate the HTML report</span>
        <span class="n">generate_html_report</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Generate the dashboard</span>
        <span class="n">generate_dashboard</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary</span></div>
</div>



<span class="c1"># %%</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">langchain_community.llms</span> <span class="kn">import</span> <span class="n">Ollama</span>
    <span class="kn">from</span> <span class="nn">langchain_openai</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>
    <span class="kn">from</span> <span class="nn">pyprojroot.here</span> <span class="kn">import</span> <span class="n">here</span>

    <span class="kn">from</span> <span class="nn">class_factory.utils.tools</span> <span class="kn">import</span> <span class="n">reset_loggers</span>
    <span class="n">reset_loggers</span><span class="p">()</span>

    <span class="n">user_home</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">here</span><span class="p">()</span>

    <span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_KEY</span><span class="p">,</span>
        <span class="n">organization</span><span class="o">=</span><span class="n">OPENAI_ORG</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># llm = Ollama(</span>
    <span class="c1">#     model=&quot;llama3.1&quot;,</span>

    <span class="c1">#     temperature=0.3</span>
    <span class="c1"># )</span>
    <span class="n">lesson_no</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># Path definitions</span>
    <span class="n">readingDir</span> <span class="o">=</span> <span class="n">user_home</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;readingsDir&#39;</span><span class="p">)</span>
    <span class="n">slideDir</span> <span class="o">=</span> <span class="n">user_home</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;slideDir&#39;</span><span class="p">)</span>
    <span class="n">syllabus_path</span> <span class="o">=</span> <span class="n">user_home</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;syllabus_path&#39;</span><span class="p">)</span>

    <span class="n">loader</span> <span class="o">=</span> <span class="n">LessonLoader</span><span class="p">(</span><span class="n">syllabus_path</span><span class="o">=</span><span class="n">syllabus_path</span><span class="p">,</span>
                          <span class="n">reading_dir</span><span class="o">=</span><span class="n">readingDir</span><span class="p">,</span>
                          <span class="n">slide_dir</span><span class="o">=</span><span class="n">slideDir</span><span class="p">)</span>

    <span class="n">maker</span> <span class="o">=</span> <span class="n">QuizMaker</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                      <span class="n">lesson_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                      <span class="n">output_dir</span><span class="o">=</span><span class="n">wd</span><span class="o">/</span><span class="s2">&quot;ClassFactoryOutput/QuizMaker&quot;</span><span class="p">,</span>
                      <span class="n">quiz_prompt_for_llm</span><span class="o">=</span><span class="n">quiz_prompt</span><span class="p">,</span>
                      <span class="n">lesson_no</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
                      <span class="n">lesson_range</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                      <span class="n">course_name</span><span class="o">=</span><span class="s2">&quot;American Government&quot;</span><span class="p">,</span>
                      <span class="n">prior_quiz_path</span><span class="o">=</span><span class="n">outputDir</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># quiz_name = wd / f&quot;ClassFactoryOutput/QuizMaker/L24/l22_24_quiz.xlsx&quot;</span>
    <span class="c1"># quiz_path = wd / f&quot;ClassFactoryOutput/QuizMaker/&quot;</span>

    <span class="n">quiz</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">make_a_quiz</span><span class="p">(</span><span class="n">difficulty_level</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># maker.save_quiz_to_ppt(quiz)</span>

    <span class="c1"># maker.save_quiz(quiz)</span>
    <span class="c1"># maker.launch_interactive_quiz(quiz_name, sample_size=5, save_results=True,</span>
    <span class="c1">#                               output_dir=quiz_path, qr_name=&quot;test_quiz&quot;)</span>
    <span class="c1"># maker.assess_quiz_results()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Sean Peters.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
